# Project 4: SM3的软件实现与优化 

## 1.实验原理

### 1.1  SM3哈希算法

SM3是中国国家密码管理局发布的一种密码杂凑算法，属于SHA-256类算法，输出长度为256位。其核心结构包括：

- **填充过程**：将消息填充至512位的倍数，填充规则为添加一个1，后接若干个0，最后添加消息长度的64位表示
- **消息扩展**：将512位的消息块扩展为132个字（W0-W67和W'0-W'63）
- **压缩函数**：使用64轮迭代处理扩展后的消息，每轮更新8个工作变量(A-H)
- **最终输出**：将最后的状态变量连接起来形成256位哈希值

### 1.2 长度扩展攻击(Length Extension Attack)

长度扩展攻击是针对Merkle-Damgård结构的哈希算法（如SM3、MD5、SHA-1等）的一种攻击方式。攻击者可以在不知道原始消息的情况下，利用原始消息的哈希值和长度，构造出`hash(original_message || padding || extension)`的有效哈希值。

攻击步骤：
1. 从原始哈希中提取内部状态
2. 计算原始消息填充后的长度
3. 构造新消息：`pad(original_message) || extension`
4. 使用原始哈希作为初始状态计算新哈希

### 1.3  RFC6962 Merkle树

RFC6962定义了用于证书透明度的Merkle树结构，特点包括：

- **叶子节点哈希**：`hash(0x00 || leaf_data)`
- **内部节点哈希**：`hash(0x01 || left_child_hash || right_child_hash)`
- **存在性证明**：从叶子到根的路径上所有兄弟节点的哈希和方向信息
- **不存在性证明**：通过证明相邻边界节点的存在来证明某节点不存在

## 2.实验过程

### 2.1 SM3算法优化实现

在`SM3.cpp`中实现了基本版本和优化版本：

- **基本实现**：严格按照算法描述实现
- **优化实现**：
  - 使用内联函数减少函数调用开销
  - 循环展开减少分支预测失败
  - 内存对齐提高缓存效率
  - 局部变量减少内存访问

### 2.2 长度扩展攻击验证

在`Length Extension Attack.py`中实现了长度扩展攻击验证：

1. 计算原始消息的哈希
2. 从哈希中提取内部状态
3. 构造填充后的消息
4. 附加扩展数据并计算新哈希
5. 验证攻击是否成功

### 2.3 Merkle树构建与证明

在`RFC6962 Merkle.py`中实现了RFC6962 Merkle树：

1. 生成10万叶子节点的测试数据
2. 构建完整的Merkle树
3. 测试存在性证明：
   - 选择特定叶子节点
   - 生成存在性证明
   - 验证证明有效性
4. 测试不存在性证明：
   - 选择不存在的叶子节点
   - 生成不存在性证明
   - 验证证明有效性

## 3.实验结果

### 3.1 SM3性能测试结果

通过`SM3.cpp`的性能测试得到：

![image](https://github.com/123234-op/2025-CSIEP-Projects/blob/main/project4/4-1.png)

### 3.2 长度扩展攻击验证结果

`Length Extension Attack.py`运行结果：

![image](https://github.com/123234-op/2025-CSIEP-Projects/blob/main/project4/4-2.png)

攻击成功验证：

- 原始消息: `b'secret_data'`
- 原始哈希: `a51360...379a9`
- 构造的新消息包含原始消息+填充+扩展(`malicious_extension`)
- 预测哈希与实际计算哈希完全一致

### 3.3 Merkle树测试结果

`RFC6962 Merkle.py`运行结果示例：

![image](https://github.com/123234-op/2025-CSIEP-Projects/blob/main/project4/4-3.png)

结果分析：

- 成功构建包含10万叶子节点的Merkle树
- 根哈希: `9a6967...7817`
- 存在性证明验证通过(叶子12345)
- 不存在性证明验证通过(测试`b'non_existent_leaf'`)

## 4.实验总结

1. **SM3优化**：通过内联函数、循环展开、内存对齐等技术，将SM3的性能提升
2. **长度扩展攻击**：验证了SM3作为Merkle-Damgård结构的哈希算法确实存在长度扩展攻击漏洞，在实际应用中，应使用HMAC或类似技术来防止此类攻击。
3. **Merkle树**：成功构建了包含10万叶子节点的大规模Merkle树，并实现了存在性和不存在性证明，验证了RFC6962标准的可行性。Merkle树在数据完整性验证方面有重要应用价值。


